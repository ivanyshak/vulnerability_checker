class GemsPack < ApplicationRecord
  require 'nokogiri'
  require 'open-uri'

  def self.parse_gems
    gems_list = []
    1.upto(14) do |index|
      doc = Nokogiri::HTML(open("https://rubysec.com/advisories?page=#{index}"))
      doc.css('table.table tr').each do |i|
        unless GemsPack.find_by_url(i.children[5].children[1].attributes['href'].value).present?
          gems_list << self.create!(gem_name: i.children.text.split.second,
            date: i.children.text.split.first.to_date,
            description: i.children.children.children[0].text,
            url: i.children[5].children[1].attributes['href'].value,
            cve: i.children.children[5].text.split(" ").join(""))
        end
      end
    end
    new_gem_email(gems_list) if gems_list.any?
  end

  def self.new_gem_email(gems_list)
    GemsMailer.new_gem_email(gems_list).deliver_now!
  end
end
